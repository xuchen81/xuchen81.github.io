$(function(){var a=new URLSearchParams(window.location.search),b=a.get("s")||6,c=parseInt(b),e=750,f=1e3,g="#282c2d",h=d3.select("#canvas").append("svg").attr("width",f).attr("height",1e3),k=3,l=10,m=[{sx:1,sy:1,width:1,height:2},{sx:2,sy:1,width:2,height:1},{sx:3,sy:2,width:2,height:1},{sx:5,sy:2,width:1,height:2},{sx:3,sy:3,width:1,height:2},{sx:4,sy:3,width:1,height:3},{sx:1,sy:4,width:2,height:1},{sx:5,sy:4,width:2,height:1},{sx:1,sy:5,width:3,height:1},{sx:1,sy:6,width:3,height:1},{sx:1,sy:3,width:2,height:1,fill:"red"}].map(function(a){return a.direction=a.width>a.height?"x":"y",a}),n=10;h.append("rect").attr("x",(f-e)/2).attr("y",n/2).attr("rx",10).attr("ry",10).attr("width",e).attr("height",e).attr("fill","#9c6017").attr("stroke-width",n).attr("stroke","#9c6017");for(var o=[],p=0;p<c;p++)for(var d=0;d<c;d++){var q=d*e/c+(f-e)/2,r=p*e/c+n/2;o.push({x:q,y:r,width:e/c,height:e/c,fill:g,stroke:"#9c6017",posn:p+"_"+d,id:"s_"+p+"_"+d,class:"spot"})}h.selectAll("rect[class='spot']").data(o).enter().append("rect").attr("x",function(a){return a.x}).attr("rx",10).attr("ry",10).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}).attr("fill",function(a){return a.fill}).attr("posn",function(a){return a.posn}).attr("stroke","#9c6017").attr("stroke-width",3).attr("id",function(a){return"s_"+a.posn}).attr("covered","no");h.append("rect").attr("x",c*e/c+(f-e)/2).attr("rx",10).attr("ry",10).attr("y",(k-1)*e/c+n/2).attr("width",100).attr("height",e/c).attr("fill",g),h.selectAll("rect[class='block']").data(m).enter().append("rect").attr("x",function(a){return(a.sx-1)*e/c+(f-e)/2+l}).attr("y",function(a){return(a.sy-1)*e/c+n/2+l}).attr("rx",10).attr("ry",10).attr("width",function(a){return a.width*e/c-2*l}).attr("height",function(a){return a.height*e/c-2*l}).attr("block-width",function(a){return a.width}).attr("block-height",function(a){return a.height}).attr("fill",function(a){return a.fill||"orange"}).attr("curry",function(a){return a.sy-1}).attr("currx",function(a){return a.sx-1}).attr("posn",function(a){return a.sy-1+"_"+(a.sx-1)}).attr("stroke","#9c6017").attr("stroke-width",3).attr("class","block").attr("id",function(a){return a.fill?"target":""});for(var s=d3.select("#target").attr("block-width"),t=k-1,u=c-s,p=0;p<m.length;p++){if(1<m[p].width)for(var d=0;d<m[p].width;d++)d3.select("#s_"+(m[p].sy-1)+"_"+(m[p].sx-1+d)).attr("covered","yes");if(1<m[p].height)for(var d=0;d<m[p].height;d++)d3.select("#s_"+(m[p].sy-1+d)+"_"+(m[p].sx-1)).attr("covered","yes")}var v=function(){return d3.select("#target").attr("posn")===t+"_"+u},w=function(a,b,d,g,i){var j,k,m=[],o=[];if("left"===i){j=a;for(var p=b-2;0<=p&&"no"===d3.select("#s_"+a+"_"+p).attr("covered");)p-=1;k=p+1}if("right"===i){j=a;for(var q=b+d-1+2;q<c&&"no"===d3.select("#s_"+a+"_"+q).attr("covered");)q+=1;k=q-d}if("up"===i){k=b;for(var r=a-2;0<=r&&"no"===d3.select("#s_"+r+"_"+b).attr("covered");)r-=1;j=r+1}if("down"===i){k=b;for(var s=a+g-1+2;s<c&&"no"===d3.select("#s_"+s+"_"+b).attr("covered");)s+=1;j=s-g}if("left"===i||"right"===i)for(var t=0;t<d;t++)m.push([a,b+t]),o.push([j,k+t]);if("up"===i||"down"===i)for(var u=0;u<g;u++)m.push([a+u,b]),o.push([j+u,k]);return m.forEach(function(a){d3.select("#s_"+a[0]+"_"+a[1]).attr("covered","no")}),o.forEach(function(a){d3.select("#s_"+a[0]+"_"+a[1]).attr("covered","yes")}),d3.select("rect[class=block][posn='"+a+"_"+b+"']").transition().duration(200).attr("x",k*e/c+(f-e)/2+l).attr("y",j*e/c+n/2+l).attr("posn",j+"_"+k).attr("currx",k).attr("curry",j),setTimeout(function(){if(v()){var a=parseInt(d3.select("#target").attr("x"));d3.select("#target").transition().duration(100).attr("x",a+50),setTimeout(function(){alert("\u606D\u559C\uFF0C\u4F60\u901A\u5173\u4E86!")},100)}},500),[j,k]};d3.selectAll("rect[class='block']").on("click",function(a){var b=parseInt(d3.select(this).attr("curry")),d=parseInt(d3.select(this).attr("currx"));if("x"===a.direction){var e=d+a.width-1;if((0===d||"yes"===d3.select("#s_"+b+"_"+(d-1)).attr("covered"))&&(e===c-1||"yes"===d3.select("#s_"+b+"_"+(e+1)).attr("covered")))return;var f,g;if(0<d&&"no"===d3.select("#s_"+b+"_"+(d-1)).attr("covered")&&(f=!0),e<c-1&&"no"===d3.select("#s_"+b+"_"+(e+1)).attr("covered")&&(g=!0),f&&g){var h=d3.mouse(this)[0];h>parseInt(d3.select(this).attr("x"))+parseInt(d3.select(this).attr("width"))/2?w(b,d,a.width,a.height,"right"):w(b,d,a.width,a.height,"left")}else f?w(b,d,a.width,a.height,"left"):g&&w(b,d,a.width,a.height,"right")}else{var i=b+a.height-1;if((0===b||"yes"===d3.select("#s_"+(b-1)+"_"+d).attr("covered"))&&(i===c-1||"yes"===d3.select("#s_"+(i+1)+"_"+d).attr("covered")))return;var j,k;if(0<b&&"no"===d3.select("#s_"+(b-1)+"_"+d).attr("covered")&&(j=!0),i<c-1&&"no"===d3.select("#s_"+(i+1)+"_"+d).attr("covered")&&(k=!0),j&&k){var l=d3.mouse(this)[1];l>parseInt(d3.select(this).attr("y"))+parseInt(d3.select(this).attr("height"))/2?w(b,d,a.width,a.height,"down"):w(b,d,a.width,a.height,"up")}else j?w(b,d,a.width,a.height,"up"):k&&w(b,d,a.width,a.height,"down")}})});