$(function(){var a=new URLSearchParams(window.location.search),b=a.get("s")||5,c=2e3,d=parseInt(b),e=750,f=1e3,g="#282c2d",h=d3.select("#canvas").append("svg").attr("width",f).attr("height",1e3),k={red:{starColor:"#fe515a",bgColor:"#ff9090",lineColor:"#fea5bb"},yellow:{starColor:"#fedc3f",bgColor:"#ffc60c",lineColor:"#fffac0"},green:{starColor:"#5efee4",bgColor:"#34d5c0",lineColor:"#90fff0"},purple:{starColor:"#ab2aff",bgColor:"#c153ff",lineColor:"#c380ff"},gray:{starColor:"#e2e2e2",bgColor:"#d3d3d3",lineColor:"#ffffff"},orange:{starColor:"#E4652D",bgColor:"#F2A050",lineColor:"#F9D6B0"}},l=[[1,1,"red"],[5,3,"red"],[1,2,"yellow"],[1,5,"yellow"],[2,2,"green"],[2,4,"green"],[2,5,"purple"],[5,4,"purple"],[3,4,"gray"],[4,2,"gray"]];6===d&&(l=[[1,1,"red"],[1,6,"yellow"],[2,3,"gray"],[2,4,"green"],[3,2,"yellow"],[3,4,"purple"],[5,5,"purple"],[6,2,"red"],[6,5,"gray"],[6,6,"green"]]),8===d&&(l=[[1,8,"purple"],[3,3,"green"],[3,5,"yellow"],[3,6,"red"],[3,7,"gray"],[5,5,"green"],[6,7,"orange"],[7,2,"red"],[7,3,"gray"],[7,4,"orange"],[8,4,"purple"],[8,5,"yellow"]],c=1200);h.append("rect").attr("x",(f-e)/2).attr("y",5).attr("rx",10).attr("ry",10).attr("width",e).attr("height",e).attr("fill","#9c6017").attr("stroke-width",10).attr("stroke","#9c6017");for(var m=[],n=0;n<d;n++)for(var o=0;o<d;o++){var p=o*e/d+(f-e)/2,q=n*e/d+5;m.push({x:p,y:q,width:e/d,height:e/d,fill:g,stroke:"#9c6017",posn:n+"_"+o,id:"r_"+n+"_"+o,class:"cell"})}h.selectAll("rect[class='cell']").data(m).enter().append("rect").attr("x",function(a){return a.x}).attr("rx",10).attr("ry",10).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}).attr("fill",function(a){return a.fill}).attr("posn",function(a){return a.posn}).attr("stroke","#9c6017").attr("stroke-width",3).attr("class","cell").attr("id",function(a){return"r_"+a.posn}).attr("hasStar","no").attr("covered","no").attr("starColor",null).attr("lineColor",null).attr("bgColor",null);for(var r=[],n=0;n<l.length;n++){var p=parseInt(d3.select("#r_"+(l[n][0]-1)+"_"+(l[n][1]-1)).attr("x")),q=parseInt(d3.select("#r_"+(l[n][0]-1)+"_"+(l[n][1]-1)).attr("y"));r.push({transform:"translate("+(p+e/d/2)+","+(q+e/d/2)+")",id:"s_"+(l[n][0]-1)+"_"+(l[n][1]-1),class:"star",size:c,fill:k[l[n][2]].starColor,posn:l[n][0]-1+"_"+(l[n][1]-1),bgColor:k[l[n][2]].bgColor,lineColor:k[l[n][2]].lineColor}),d3.select("#r_"+(l[n][0]-1)+"_"+(l[n][1]-1)).attr("hasStar","yes")}var s=d3.symbol().type(d3.symbolStar),t=function(a){h.selectAll("path[class='star']").data(a).enter().append("path").attr("transform",function(a){return a.transform}).attr("posn",function(a){return a.posn}).attr("id",function(a){return a.id}).attr("d",function(a){return s.size(a.size),s()}).attr("class","star").attr("fill",function(a){return a.fill}).on("mousedown",a=>{d3.select("#r_"+a.posn).dispatch("mousedown")}).on("mouseup",a=>{d3.select("#r_"+a.posn).dispatch("mouseup")})};t(r);var u=function(a,b){var c=parseInt(a.split("_")[0]),d=parseInt(a.split("_")[1]),e=parseInt(b.split("_")[0]),f=parseInt(b.split("_")[1]);return 1>=Math.abs(c-e)+Math.abs(d-f)},v=function(a,b){for(var c=d3.select("#r_"+a+"_"+b).attr("fill"),e=d3.select("#r_"+a+"_"+b).attr("lineColor"),f=d3.select("rect[hasStar='yes'][bgColor='"+c+"']").attr("posn"),g=parseInt(f.split("_")[0]),h=parseInt(f.split("_")[1]),k=[],l={},m=[[g,h]],n={};0<m.length;){var o=m.pop(),p=o[0]+"_"+o[1];n[p]=1,0<=o[0]-1&&d3.select("#r_"+(o[0]-1)+"_"+o[1]).attr("fill")===c&&!(o[0]-1+"_"+o[1]in n)&&m.push([o[0]-1,o[1]]),o[0]+1<d&&d3.select("#r_"+(o[0]+1)+"_"+o[1]).attr("fill")===c&&!(o[0]+1+"_"+o[1]in n)&&m.push([o[0]+1,o[1]]),0<=o[1]-1&&d3.select("#r_"+o[0]+"_"+(o[1]-1)).attr("fill")===c&&!(o[0]+"_"+(o[1]-1)in n)&&m.push([o[0],o[1]-1]),o[1]+1<d&&d3.select("#r_"+o[0]+"_"+(o[1]+1)).attr("fill")===c&&!(o[0]+"_"+(o[1]+1)in n)&&m.push([o[0],o[1]+1]),("yes"===d3.select("#r_"+p).attr("covered")||"yes"===d3.select("#r_"+p).attr("hasStar"))&&d3.select("#r_"+p).attr("fill")===c&&(l[p]=d3.select("#r_"+p).data()[0],k.push(d3.select("#r_"+p).data()[0]))}for(var q=[f],r=d3.selectAll("line[lineColor='"+e+"']").nodes().map(function(a){return d3.select(a).attr("connection").split("_to_")}),s={[f]:1};q.length<=r.length;)for(var a=0;a<r.length;a++)r[a][0]!==q[q.length-1]||r[a][1]in s||(q.push(r[a][1]),s[r[a][1]]=1),r[a][1]!==q[q.length-1]||r[a][0]in s||(q.push(r[a][0]),s[r[a][0]]=1);for(var t=[],a=0;a<q.length;a++)for(var b=0;b<k.length;b++)if(k[b].posn===q[a]){t.push(k[b]);break}return[t,l]},w=function(a,b,c){for(var d=-1,e=0;e<a.length;e++)if(c===a[e].posn){d=e;break}for(var e=d;e<=a.length-2;e++){var f=a[e].posn,h=a[e+1].posn,j=[f,h];j.sort(),d3.select("line[connection='"+j.join("_to_")+"']").remove(),d3.select("#r_"+a[e+1].posn).attr("fill",g).attr("covered","no"),delete b[a[e+1].posn]}return[a.slice(0,d+1),b]},z=function(){return d3.selectAll("rect[covered='yes']").size()+d3.selectAll("rect[hasStar='yes']").size()===d*d},A=function(a,b,c,f){var g,h,k=a.x+e/d/2,l=a.y+e/d/2,m=b.x+e/d/2,n=b.y+e/d/2;if(b.x===a.x){h=parseInt(a.posn.split("_")[1]);[l,n].sort(),g=f<=Math.min(l,n)+e/d/2?l<n?parseInt(a.posn.split("_")[0]):parseInt(b.posn.split("_")[0]):l<n?parseInt(b.posn.split("_")[0]):parseInt(a.posn.split("_")[0])}else g=parseInt(a.posn.split("_")[0]),h=c<=Math.min(k,m)+e/d/2?k<m?parseInt(a.posn.split("_")[1]):parseInt(b.posn.split("_")[1]):k<m?parseInt(b.posn.split("_")[1]):parseInt(a.posn.split("_")[1]);return[g,h]};d3.selectAll("rect[class='cell']").on("mousedown",a=>{var b=d3.select("#s_"+a.posn),c=d3.select("#r_"+a.posn);if("no"===c.attr("hasStar")&&"no"===c.attr("covered"))return void console.log("Can NOT start from here");if(this.trace=[],this.traceMap={},this.startingRectNodeData=c.data()[0],this.endingRectNodeData=null,this.bgColor=c.attr("bgColor"),this.lineColor=c.attr("lineColor"),this.starColor=c.attr("starColor"),"yes"===c.attr("hasStar")&&(d3.selectAll("rect[fill='"+this.bgColor+"']").attr("fill",g).attr("bgColor",null).attr("lineColor",null).attr("covered","no"),d3.selectAll("line[lineColor='"+this.lineColor+"']").remove()),this.trace.push(this.startingRectNodeData),this.traceMap[a.posn]=this.startingRectNodeData,"no"===c.attr("hasStar")&&"yes"===c.attr("covered")){var d=v(parseInt(a.posn.split("_")[0]),parseInt(a.posn.split("_")[1])),e=d[0],f=d[1];this.startingRectNodeData=e[0],b=d3.select("#s_"+e[0].posn),c=d3.select("#r_"+e[0].posn);var h=w(e,f,a.posn);this.trace=h[0],this.traceMap=h[1]}b&&(this.bgColor=b.data()[0].bgColor,this.lineColor=b.data()[0].lineColor,this.starColor=b.data()[0].fill),c.attr("fill",this.bgColor),c.attr("bgColor",this.bgColor),c.attr("lineColor",this.lineColor),c.attr("starColor",this.starColor)}).on("mouseover",a=>{if(this.startingRectNodeData&&!u(a.posn,this.trace[this.trace.length-1].posn))return void console.log("You can NOT jump a spot.");if(!(this.startingRectNodeData&&3<=this.trace.length&&this.startingRectNodeData.posn===a.posn)){var b=d3.select("#r_"+a.posn),c=d3.select("#s_"+a.posn);if(this.startingRectNodeData&&"yes"===b.attr("hasStar")&&c.attr("fill")!==this.starColor)return void console.log("This star has a different color, can NOT be connected.");if(this.startingRectNodeData&&"yes"===d3.select("#r_"+a.posn).attr("covered")&&d3.select("#r_"+a.posn).attr("bgColor")!==this.bgColor)return void console.log("Two colors can NOT cross.");if(this.startingRectNodeData&&2<=this.trace.length){var f=this.trace[this.trace.length-1].posn;if("yes"===d3.select("#r_"+f).attr("hasStar")&&d3.select("#s_"+f).attr("fill")===this.starColor&&!(a.posn in this.traceMap))return void console.log("You have complete a connection, invalid move.")}if(this.startingRectNodeData&&!this.endingRectNodeData){var i=a;if("star"===a.class&&(i=d3.select("#r_"+a.posn).data()[0]),!(a.posn in this.traceMap)){this.trace.push(b.data()[0]),this.traceMap[a.posn]=b.data()[0];var j=d3.select("#s_"+this.startingRectNodeData.posn).data()[0].bgColor;if(d3.select("#r_"+a.posn).attr("fill",j).attr("bgColor",this.bgColor).attr("lineColor",this.lineColor),"no"===d3.select("#r_"+a.posn).attr("hasStar")&&d3.select("#r_"+a.posn).attr("covered","yes"),1<this.trace.length){var k=this.trace[this.trace.length-2],l=this.trace[this.trace.length-1],m=[k.posn,l.posn];m.sort(),h.append("line").style("stroke",this.lineColor).style("stroke-width",10).attr("x1",k.x+e/d/2).attr("y1",k.y+e/d/2).attr("x2",l.x+e/d/2).attr("y2",l.y+e/d/2).attr("lineColor",this.lineColor).attr("class","line").attr("connection",m.join("_to_")).on("mousedown",function(){var a=A(k,l,d3.mouse(this)[0],d3.mouse(this)[1]);d3.select("#r_"+a[0]+"_"+a[1]).dispatch("mousedown")}).on("mouseup",function(){var a=A(k,l,d3.mouse(this)[0],d3.mouse(this)[1]);d3.select("#r_"+a[0]+"_"+a[1]).dispatch("mouseup")}),d3.selectAll("path[class='star']").remove(),t(r)}}else if(a.posn in this.traceMap&&a.posn!==this.trace[this.trace.length-1].posn){if(2<=this.trace.length&&a.posn!=this.trace[this.trace.length-2].posn)return void console.log("You can NOT go back by Jumping.");var m=[a.posn,this.trace[this.trace.length-1].posn];m.sort(),d3.select("line[connection='"+m.join("_to_")+"']").remove(),d3.select("#r_"+this.trace[this.trace.length-1].posn).attr("fill",g).attr("covered","no"),delete this.traceMap[this.trace[this.trace.length-1].posn],this.trace.pop()}}}}).on("mouseup",a=>{this.startingRectNodeData=null,this.endingRectNodeData=a,this.trace=[],this.traceMap={},z()&&alert("\u606D\u559C\uFF0C\u4F60\u80DC\u5229\u4E86\uFF01")})});